{% extends 'base.html' %}

{% block title %}CSV to Iceberg - Job Status{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h2 class="mb-4">Job Status</h2>
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Job ID: {{ job_id }}</span>
                <a href="{{ url_for('jobs') }}" class="btn btn-secondary btn-sm">Back to Jobs</a>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h5>Status</h5>
                    {% if job.status == 'running' %}
                        <div class="alert alert-info">
                            <strong>Running</strong> - Conversion is in progress...
                            {% if job.started_at %}
                                <br>
                                <small>Started at: {{ job.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                <br>
                                <small>Running for: {{ format_duration(job.started_at, now) }}</small>
                            {% endif %}
                        </div>
                        <div class="progress mb-3" style="height: 25px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info fs-6" role="progressbar" aria-valuenow="{{ job.progress|default(0) }}" aria-valuemin="0" aria-valuemax="100" style="width: {{ job.progress|default(0) }}%">
                                <span id="progress-percent">{{ job.progress|default(0) }}%</span>
                            </div>
                        </div>
                        <p id="progress-text" class="text-center">Converting CSV to Iceberg - <span id="progress-status">In Progress</span></p>
                    {% elif job.status == 'completed' %}
                        <div class="alert alert-success">
                            <strong>Completed</strong> - Conversion completed successfully.
                            {% if job.started_at and job.completed_at %}
                                <br>
                                <small>Started at: {{ job.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                <br>
                                <small>Completed at: {{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                <br>
                                <small>Duration: {{ format_duration(job.started_at, job.completed_at) }}</small>
                            {% elif job.completed_at %}
                                <br>
                                <small>Completed at: {{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="alert alert-danger">
                            <strong>Failed</strong> - Conversion failed.
                            {% if job.started_at and job.completed_at %}
                                <br>
                                <small>Started at: {{ job.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                <br>
                                <small>Failed at: {{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                <br>
                                <small>Duration: {{ format_duration(job.started_at, job.completed_at) }}</small>
                            {% elif job.completed_at %}
                                <br>
                                <small>Failed at: {{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <h5>File</h5>
                    <p>{{ job.filename }}</p>
                </div>
                
                <div class="mb-3">
                    <h5>Table</h5>
                    <p>{{ job.params.table_name }}</p>
                </div>
                
                <div class="mb-3">
                    <h5>Parameters</h5>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Trino Host
                            <span class="badge bg-primary rounded-pill">{{ job.params.trino_host }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Trino Port
                            <span class="badge bg-primary rounded-pill">{{ job.params.trino_port }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Trino User
                            <span class="badge bg-primary rounded-pill">{{ job.params.trino_user }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Trino Authentication
                            <span class="badge bg-primary rounded-pill">{% if job.params.trino_password %}Enabled{% else %}Disabled{% endif %}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Trino Catalog
                            <span class="badge bg-primary rounded-pill">{{ job.params.trino_catalog }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Trino Schema
                            <span class="badge bg-primary rounded-pill">{{ job.params.trino_schema }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Hive Metastore URI
                            <span class="badge bg-primary rounded-pill">{{ job.params.hive_metastore_uri }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Mode
                            <span class="badge bg-primary rounded-pill">{{ job.params.mode }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Delimiter
                            <span class="badge bg-primary rounded-pill">{{ job.params.delimiter }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Has Header
                            <span class="badge bg-primary rounded-pill">{{ job.params.has_header }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Quote Character
                            <span class="badge bg-primary rounded-pill">{{ job.params.quote_char }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Batch Size
                            <span class="badge bg-primary rounded-pill">{{ job.params.batch_size }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Sample Size
                            <span class="badge bg-primary rounded-pill">{{ job.params.sample_size }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Verbose
                            <span class="badge bg-primary rounded-pill">{{ job.params.verbose }}</span>
                        </li>
                    </ul>
                </div>
                
                {% if job.status != 'running' %}
                    <div class="mb-3">
                        <h5>Output</h5>
                        <div class="card">
                            <div class="card-body">
                                <pre class="mb-0 p-3 bg-dark text-light rounded">{{ job.stdout }}</pre>
                            </div>
                        </div>
                    </div>
                    
                    {% if job.stderr %}
                        <div class="mb-3">
                            <h5>Errors</h5>
                            <div class="card">
                                <div class="card-body">
                                    <pre class="mb-0 p-3 bg-dark text-light rounded">{{ job.stderr }}</pre>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if job.error %}
                        <div class="mb-3">
                            <h5>Exception</h5>
                            <div class="card">
                                <div class="card-body">
                                    <pre class="mb-0 p-3 bg-dark text-light rounded">{{ job.error }}</pre>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
                
                {% if job.status == 'running' %}
                    <div class="d-flex justify-content-between mt-3">
                        <span class="text-muted">The job is running. This page will refresh automatically.</span>
                        <a href="{{ url_for('job_status', job_id=job_id) }}" class="btn btn-primary">Refresh</a>
                    </div>
                {% endif %}
                
                <!-- Add job retention policy information -->
                {% if job.status in ['completed', 'failed'] and job.completed_at %}
                    <div class="alert alert-secondary mt-4">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            <strong>Job Retention:</strong> This {{ 'test' if job_id.startswith('test_') or job_id.startswith('running_test_') else 'regular' }} job will remain in memory for 
                            <strong>{{ (job_ttl / 60)|int }} minutes</strong> after completion.
                            <br>
                            <small class="text-muted">
                                Job completed at {{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}.
                                Job data will be removed after {{ (job_ttl / 60)|int }} minutes of inactivity
                                unless this page is actively being viewed.
                            </small>
                        </small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if job.status == 'running' %}
<script>
    // Debug logging function
    function log(message) {
        console.log(message);
    }
    
    // Function to update progress bar and text
    function updateProgress() {
        log('Polling for progress updates...');
        
        fetch('/job/{{ job_id }}/progress')
            .then(response => {
                log(`Response status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                log(`Progress data: ${JSON.stringify(data)}`);
                
                // Update progress bar width and text
                const progressBar = document.getElementById('progress-bar');
                const progressPercent = document.getElementById('progress-percent');
                
                // Make sure progress is at least 0 and at most 100
                const progress = Math.min(100, Math.max(0, data.progress || 0));
                log(`Setting progress to: ${progress}%`);
                
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                progressPercent.textContent = progress + '%';
                
                // Update the status text with server-provided phase if available
                const progressStatus = document.getElementById('progress-status');
                if (progressStatus) {
                    if (data.phase) {
                        // Use the server-provided phase information
                        progressStatus.textContent = data.phase;
                    } else {
                        // Fallback to client-side phase determination
                        if (progress < 25) {
                            progressStatus.textContent = 'Preparing...';
                        } else if (progress < 50) {
                            progressStatus.textContent = 'Schema Analysis';
                        } else if (progress < 75) {
                            progressStatus.textContent = 'Writing Data';
                        } else if (progress < 100) {
                            progressStatus.textContent = 'Finalizing...';
                        } else {
                            progressStatus.textContent = 'Completed!';
                        }
                    }
                }
                
                // Keep the animation running for all "running" jobs
                progressBar.classList.add('progress-bar-animated');
                progressBar.classList.add('bg-info');
                
                // If job is still running, poll again after 1 second
                if (data.status === 'running') {
                    log('Job still running, will poll again in 1 second');
                    setTimeout(updateProgress, 1000);
                } else {
                    log(`Job status changed to: ${data.status}`);
                    // Otherwise, reload the page to show completion
                    window.location.reload();
                }
            })
            .catch(error => {
                console.error('Error fetching progress:', error);
                log(`Error fetching progress: ${error}`);
                
                // Check if this might be a 404 from a job that has already been removed
                if (error.message && error.message.includes('404')) {
                    // Job may have been deleted or expired, show a friendly message
                    log('Job not found (404), refreshing page to show updated status');
                    window.location.reload(); // Reload to show completed status
                } else {
                    // For other errors, try again
                    log('Other error occurred, trying again in 2 seconds');
                    setTimeout(updateProgress, 2000);
                }
            });
    }
    
    // Start progress updates when page loads
    document.addEventListener('DOMContentLoaded', function() {
        log('Page loaded, starting progress updates');
        // Add default animation to the progress bar
        const progressBar = document.getElementById('progress-bar');
        progressBar.classList.add('progress-bar-animated');
        progressBar.classList.add('bg-info');
        
        // Start polling for updates
        updateProgress();
    });
</script>
{% endif %}
{% endblock %}