{% extends 'base.html' %}

{% block title %}CSV to Iceberg - Convert{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-12">
            <h2 class="mb-4">Convert CSV to Iceberg</h2>
            
            <div class="card">
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                      {% if messages %}
                        {% for category, message in messages %}
                          <div class="alert alert-{{ category }}">{{ message }}</div>
                        {% endfor %}
                      {% endif %}
                    {% endwith %}
                    
                    <form method="post" enctype="multipart/form-data">
                        <div class="mb-3">
                            <h5>Step 1: Select Profile</h5>
                        </div>
                        
                        <div class="mb-3">
                            <label for="profile" class="form-label">Connection Profile</label>
                            <select class="form-select" id="profile" name="profile" required>
                                <option value="" disabled selected>Select a profile</option>
                                {% for profile in profiles %}
                                <option value="{{ profile.name }}" 
                                        data-type="{{ profile.profile_type }}"
                                        {% if last_used_profile == profile.name %}selected{% endif %}>
                                    {{ profile.name }} - {{ profile.description }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                Select a connection profile for Trino/Iceberg access.
                                <a href="{{ url_for('routes.profiles') }}">Manage profiles</a>
                            </div>
                        </div>

                        <!-- Trino-specific fields -->
                        <div id="trino_fields" class="connection-fields" style="display: none;">
                            <div class="mb-3">
                                <h5>Trino Connection</h5>
                            </div>
                            
                            <div class="mb-3">
                                <label for="trino_host" class="form-label">Trino Host</label>
                                <input type="text" class="form-control" id="trino_host" name="trino_host" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="trino_port" class="form-label">Trino Port</label>
                                <input type="number" class="form-control" id="trino_port" name="trino_port" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="trino_user" class="form-label">Trino User</label>
                                <input type="text" class="form-control" id="trino_user" name="trino_user">
                            </div>
                            
                            <div class="mb-3">
                                <label for="trino_password" class="form-label">Trino Password</label>
                                <input type="password" class="form-control" id="trino_password" name="trino_password">
                            </div>
                            
                            <div class="mb-3">
                                <label for="http_scheme" class="form-label">HTTP Scheme</label>
                                <select class="form-select" id="http_scheme" name="http_scheme">
                                    <option value="http">HTTP</option>
                                    <option value="https" selected>HTTPS</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="trino_role" class="form-label">Trino Role</label>
                                <input type="text" class="form-control" id="trino_role" name="trino_role">
                            </div>
                            
                            <div class="mb-3">
                                <label for="trino_catalog" class="form-label">Catalog</label>
                                <input type="text" class="form-control" id="trino_catalog" name="trino_catalog" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="trino_schema" class="form-label">Schema</label>
                                <input type="text" class="form-control" id="trino_schema" name="trino_schema" required>
                            </div>
                        </div>

                        <!-- S3 Tables-specific fields -->
                        <div id="s3tables_fields" class="connection-fields" style="display: none;">
                            <div class="mb-3">
                                <h5>S3 Tables Connection</h5>
                            </div>
                            
                            <div class="mb-3">
                                <label for="region" class="form-label">AWS Region</label>
                                <input type="text" class="form-control" id="region" name="region" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="table_bucket_arn" class="form-label">Table Bucket ARN</label>
                                <input type="text" class="form-control" id="table_bucket_arn" name="table_bucket_arn" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="aws_access_key_id" class="form-label">AWS Access Key ID</label>
                                <input type="text" class="form-control" id="aws_access_key_id" name="aws_access_key_id">
                            </div>
                            
                            <div class="mb-3">
                                <label for="aws_secret_access_key" class="form-label">AWS Secret Access Key</label>
                                <input type="password" class="form-control" id="aws_secret_access_key" name="aws_secret_access_key">
                            </div>
                        </div>

                        <div class="mb-3">
                            <h5>Step 2: Upload CSV File</h5>
                        </div>
                        
                        <div class="mb-3">
                            <label for="csv_file" class="form-label">CSV File</label>
                            <input type="file" class="form-control" id="csv_file" name="csv_file" accept=".csv" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="table_name" class="form-label">Table Name</label>
                            <input type="text" class="form-control" id="table_name" name="table_name" required>
                            <div class="form-text">For Trino: catalog.schema.table, For S3 Tables: namespace.table</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="delimiter" class="form-label">CSV Delimiter</label>
                            <input type="text" class="form-control" id="delimiter" name="delimiter" value=",">
                        </div>
                        
                        <div class="mb-3">
                            <label for="has_header" class="form-label">CSV Has Header</label>
                            <select class="form-select" id="has_header" name="has_header">
                                <option value="true" selected>Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="quote_char" class="form-label">CSV Quote Character</label>
                            <input type="text" class="form-control" id="quote_char" name="quote_char" value='"'>
                        </div>
                        
                        <div class="mb-3">
                            <label for="batch_size" class="form-label">Batch Size</label>
                            <input type="number" class="form-control" id="batch_size" name="batch_size" value="10000">
                        </div>
                        
                        <div class="mb-3">
                            <label for="mode" class="form-label">Write Mode</label>
                            <select class="form-select" id="mode" name="mode">
                                <option value="append" selected>Append</option>
                                <option value="overwrite">Overwrite</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sample_size" class="form-label">Schema Inference Sample Size</label>
                            <input type="number" class="form-control" id="sample_size" name="sample_size" value="1000">
                        </div>
                        
                        <div class="mb-3">
                            <label for="include_columns" class="form-label">Include Columns (comma-separated)</label>
                            <input type="text" class="form-control" id="include_columns" name="include_columns">
                        </div>
                        
                        <div class="mb-3">
                            <label for="exclude_columns" class="form-label">Exclude Columns (comma-separated)</label>
                            <input type="text" class="form-control" id="exclude_columns" name="exclude_columns">
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Convert</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const profileSelect = document.getElementById('profile');
    const trinoFields = document.getElementById('trino_fields');
    const s3tablesFields = document.getElementById('s3tables_fields');
    
    function updateFields() {
        const selectedOption = profileSelect.options[profileSelect.selectedIndex];
        const profileType = selectedOption.dataset.type;
        
        if (profileType === 'trino') {
            trinoFields.style.display = 'block';
            s3tablesFields.style.display = 'none';
        } else if (profileType === 's3tables') {
            trinoFields.style.display = 'none';
            s3tablesFields.style.display = 'block';
        } else {
            trinoFields.style.display = 'none';
            s3tablesFields.style.display = 'none';
        }
    }
    
    // Initial update
    updateFields();
    
    // Update on change
    profileSelect.addEventListener('change', updateFields);
});
</script>
{% endblock %}
{% endblock %}