{% extends 'base.html' %}

{% block title %}CSV to Iceberg - {{ 'Edit' if profile else 'Add' }} Profile{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h2 class="mb-4">{{ 'Edit' if profile else 'Add' }} Connection Profile</h2>
        
        <div class="card">
            <div class="card-body">
                <form method="post" action="{{ url_for('routes.profile_edit', name=profile.name) if profile else url_for('routes.profile_add') }}">
                    <div class="mb-3">
                        <h5>Profile Information</h5>
                    </div>
                    
                    <div class="mb-3">
                        <label for="name" class="form-label">Profile Name</label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ profile.name if profile else '' }}" required {% if profile %}readonly{% endif %}>
                        <div class="form-text">A unique name for this connection profile.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <input type="text" class="form-control" id="description" name="description" value="{{ profile.description if profile else '' }}">
                        <div class="form-text">Optional description to help identify this profile.</div>
                    </div>

                    <div class="mb-3">
                        <label for="profile_type" class="form-label">Profile Type</label>
                        <select class="form-select" id="profile_type" name="profile_type" required>
                            <option value="trino" {% if profile and profile.profile_type == 'trino' %}selected{% elif not profile %}selected{% endif %}>Trino</option>
                            <option value="s3tables" {% if profile and profile.profile_type == 's3tables' %}selected{% endif %}>S3 Tables</option>
                        </select>
                        <div class="form-text">Select the type of connection profile.</div>
                    </div>
                    
                    <!-- Trino Connection Fields -->
                    <div id="trino_fields" class="connection-fields">
                        <div class="mb-3">
                            <h5>Trino Connection</h5>
                        </div>
                        
                        <div class="mb-3">
                            <label for="trino_host" class="form-label">Trino Host</label>
                            <input type="text" class="form-control trino-field" id="trino_host" name="trino_host" value="{{ profile.trino_host if profile else 'sep.sdp-dev.pd.switchnet.nv' }}">
                            <div class="form-text">The hostname of your Trino server.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="trino_port" class="form-label">Trino Port</label>
                            <input type="number" class="form-control trino-field" id="trino_port" name="trino_port" value="{{ profile.trino_port if profile else 443 }}">
                            <div class="form-text">The port number of your Trino server.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="trino_user" class="form-label">Trino User</label>
                            <input type="text" class="form-control" id="trino_user" name="trino_user" value="{{ profile.trino_user if profile else '' }}">
                            <div class="form-text">Your Trino username.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="trino_password" class="form-label">Trino Password</label>
                            <input type="password" class="form-control" id="trino_password" name="trino_password" value="{{ profile.trino_password if profile else '' }}">
                            <div class="form-text">Your Trino password.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="http_scheme" class="form-label">HTTP Scheme</label>
                            <select class="form-select" id="http_scheme" name="http_scheme">
                                <option value="http" {% if profile and profile.http_scheme == 'http' %}selected{% elif not profile %}{% endif %}>HTTP</option>
                                <option value="https" {% if profile and profile.http_scheme == 'https' %}selected{% elif not profile %}selected{% endif %}>HTTPS</option>
                            </select>
                            <div class="form-text">The HTTP scheme to use for connecting to Trino.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="trino_role" class="form-label">Trino Role</label>
                            <input type="text" class="form-control" id="trino_role" name="trino_role" value="{{ profile.trino_role if profile else 'sysadmin' }}">
                            <div class="form-text">Your Trino role.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="trino_catalog" class="form-label">Default Catalog</label>
                            <input type="text" class="form-control trino-field" id="trino_catalog" name="trino_catalog" value="{{ profile.trino_catalog if profile else 'iceberg' }}">
                            <div class="form-text">The default catalog to use.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="trino_schema" class="form-label">Default Schema</label>
                            <input type="text" class="form-control trino-field" id="trino_schema" name="trino_schema" value="{{ profile.trino_schema if profile else 'default' }}">
                            <div class="form-text">The default schema to use.</div>
                        </div>
                        
                        <div class="mb-3">
                            <h5>Hive Metastore</h5>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="use_hive_metastore" name="use_hive_metastore" value="true" 
                                   {% if profile and profile.use_hive_metastore %}checked{% elif not profile %}checked{% endif %}>
                            <label class="form-check-label" for="use_hive_metastore">Use direct Hive Metastore connection</label>
                            <div class="form-text">When disabled, all operations will be performed through Trino only. Hive Metastore URI is optional when disabled.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="hive_metastore_uri" class="form-label">Hive Metastore URI</label>
                            <input type="text" class="form-control" id="hive_metastore_uri" name="hive_metastore_uri" value="{{ profile.hive_metastore_uri if profile else 'localhost:9083' }}">
                            <div class="form-text">Format: host:port</div>
                        </div>
                    </div>

                    <!-- S3 Tables Connection Fields -->
                    <div id="s3tables_fields" class="connection-fields" style="display: none;">
                        <div class="mb-3">
                            <h5>S3 Tables Connection</h5>
                        </div>
                        
                        <div class="mb-3">
                            <label for="region" class="form-label">AWS Region</label>
                            <input type="text" class="form-control s3tables-field" id="region" name="region" value="{{ profile.region if profile else 'us-east-1' }}">
                            <div class="form-text">The AWS region where your S3 Tables are located.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="table_bucket_arn" class="form-label">Table Bucket ARN</label>
                            <input type="text" class="form-control s3tables-field" id="table_bucket_arn" name="table_bucket_arn" value="{{ profile.table_bucket_arn if profile else '' }}">
                            <div class="form-text">
                                The full ARN of your S3 bucket where tables will be stored.<br>
                                Format: <code>arn:aws:s3:::bucket-name</code><br>
                                Example: <code>arn:aws:s3:::my-iceberg-tables</code>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="namespace" class="form-label">Namespace</label>
                            <input type="text" class="form-control s3tables-field" id="namespace" name="namespace" value="{{ profile.namespace if profile else '' }}">
                            <div class="form-text">The namespace for your S3 Tables (equivalent to schema in Trino)</div>
                        </div>

                        <div class="mb-3">
                            <label for="aws_access_key_id" class="form-label">AWS Access Key ID</label>
                            <input type="text" class="form-control" id="aws_access_key_id" name="aws_access_key_id" value="{{ profile.aws_access_key_id if profile else '' }}">
                            <div class="form-text">Optional if using IAM role or environment credentials.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="aws_secret_access_key" class="form-label">AWS Secret Access Key</label>
                            <input type="password" class="form-control" id="aws_secret_access_key" name="aws_secret_access_key" value="{{ profile.aws_secret_access_key if profile else '' }}">
                            <div class="form-text">Optional if using IAM role or environment credentials.</div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Save Profile</button>
                        <a href="{{ url_for('routes.profiles') }}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Profile form script loaded');
    
    const profileTypeSelect = document.getElementById('profile_type');
    const trinoFields = document.getElementById('trino_fields');
    const s3tablesFields = document.getElementById('s3tables_fields');
    
    console.log('Profile type select element:', profileTypeSelect);
    console.log('Trino fields element:', trinoFields);
    console.log('S3 Tables fields element:', s3tablesFields);
    
    function updateFields() {
        console.log('Updating fields based on profile type');
        const selectedType = profileTypeSelect.value;
        console.log('Selected profile type:', selectedType);
        
        // Update required attributes based on profile type
        document.querySelectorAll('.trino-field').forEach(field => {
            field.required = selectedType === 'trino';
        });
        
        document.querySelectorAll('.s3tables-field').forEach(field => {
            field.required = selectedType === 's3tables';
        });
        
        if (selectedType === 'trino') {
            trinoFields.style.display = 'block';
            s3tablesFields.style.display = 'none';
        } else {
            trinoFields.style.display = 'none';
            s3tablesFields.style.display = 'block';
        }
    }
    
    // Initial update
    updateFields();
    
    // Update on change
    profileTypeSelect.addEventListener('change', function() {
        console.log('Profile type changed to:', this.value);
        updateFields();
    });
});
</script>
{% endblock %}
{% endblock %}